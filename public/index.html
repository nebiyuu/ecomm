<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ecom API Reference</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 32px; line-height: 1.4; }
    h1 { margin-bottom: 4px; }
    h2 { margin-top: 28px; border-bottom: 1px solid #ccc; padding-bottom: 4px; }
    h3 { margin-top: 18px; }
    code, pre { background: color-mix(in oklab, Canvas 92%, black 8%); padding: 2px 6px; border-radius: 6px; }
    pre { padding: 12px; overflow: auto; }
    .endpoint { margin: 14px 0; padding: 12px; border: 1px solid #ddd; border-radius: 8px; }
    .method { font-weight: 700; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; font-weight: 600; margin-left: 6px; }
    .auth { background: #e1f5fe; color: #01579b; }
    .protected { background: #f3e5f5; color: #4a148c; }
    .note { font-size: 13px; color: #666; }
    ul { margin: 8px 0 0 18px; }
    .grid { display: grid; gap: 8px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
  </style>
</head>
<body>
  <h1>Ecom API Reference</h1>
  <div class="note">Base URL: <code>/api</code>. All request/response bodies are JSON.</div>

  <h2>Users (Unified auth)</h2>



  <div class="endpoint">
    <div><span class="method">DELETE</span> <code>/api/users/:id</code> <span class="pill protected">JWT</span></div>
    <div>Deletes the user and related Seller/Buyer records. Only the same user or an admin can perform this.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Params: <code>id</code> — User ID</li>
      <li>Body: none</li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "message": "User and related records deleted" }</code></li>
      <li>401: <code>{ "message": "Unauthorized" }</code></li>
      <li>403: <code>{ "message": "Forbidden" }</code></li>
      <li>404: <code>{ "message": "User not found" }</code></li>
      <li>500: <code>{ "message": "Error deleting user", "error": "..." }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">POST</span> <code>/api/users/resend-otp</code> <span class="pill auth">Public</span></div>
    <div>Resends a new verification code (buyers or sellers).</div>
    <h4>Request body</h4>
<pre>{
  "email": "user@example.com"
}</pre>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "message": "OTP resent to buyer/seller email" }</code></li>
      <li>400 | 404 | 200 (already verified): same as send-otp</li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">POST</span> <code>/api/users/verify-email</code> <span class="pill auth">Public</span></div>
    <div>Verifies the code, marks emailVerified, ensures a User exists, and returns JWT.</div>
    <h4>Request body</h4>
<pre>{
  "email": "user@example.com",
  "otp": "123456"
}</pre>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ message, token, user: { id, username, email, role } }</code></li>
      <li>400: <code>email and otp required | No OTP pending | OTP expired | Invalid OTP</code></li>
      <li>404: <code>Account not found</code></li>
      <li>429: <code>Too many attempts. Request a new OTP</code></li>
      <li>200 (already verified): <code>{ "message": "Email already verified" }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">POST</span> <code>/api/users/login</code> <span class="pill auth">Public</span></div>
    <div>Universal login for buyer, seller, and admin. Role is resolved from User.</div>
    <h4>Request body</h4>
<pre>{
  "username": "username-or-email",
  "password": "secret"
}</pre>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ message, token, user: { id, username, email, role } }</code></li>
      <li>400/401/404: <code>User not found | Invalid password | All fields required</code></li>
      <li>403 (buyer/seller): <code>Email not verified</code></li>
      <li>403 (seller): <code>Seller not approved yet</code></li>
    </ul>
  </div>

  <h2>Products</h2>

  <div class="endpoint">
    <div><span class="method">GET</span> <code>/api/products</code> <span class="pill auth">Public</span></div>
    <div>Lists all products. Supports filtering by category. Admins can see soft-deleted products as well.</div>
    <h4>Request</h4>
    <ul>
      <li>No authentication required for basic listing</li>
      <li>Query Parameters (optional):
        <ul>
          <li><code>category</code> — Filter products by category (e.g., <code>?category=Mobile Phones & Tablets</code>)</li>
        </ul>
      </li>
      <li>Admins can include deleted products in results</li>
    </ul>
    <h4>Examples</h4>
    <ul>
      <li><code>GET /api/products</code> — Get all products</li>
      <li><code>GET /api/products?category=Mobile Phones & Tablets</code> — Get only Mobile Phones & Tablets</li>
      <li><code>GET /api/products?category=Computers & Laptops</code> — Get only Computers & Laptops</li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "success": true, "count": number, "data": Product[] }</code></li>
      <li>500: <code>{ "success": false, "message": "Error retrieving products", "error": "..." }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">GET</span> <code>/api/products/:id</code> <span class="pill auth">Public</span></div>
    <div>Get a specific product by ID.</div>
    <h4>Request</h4>
    <ul>
      <li>Params: <code>id</code> — Product ID (required)</li>
      <li>Admins can retrieve soft-deleted products</li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "success": true, "data": Product }</code></li>
      <li>404: <code>{ "success": false, "message": "Product not found" }</code></li>
      <li>500: <code>{ "success": false, "message": "Error retrieving product", "error": "..." }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">POST</span> <code>/api/products</code> <span class="pill protected">JWT (Seller/Admin)</span></div>
    <div>Creates a new product. Only authenticated sellers or admins can create products.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Body (JSON):
<pre>{
  "name": "string (required, min 3, max 100 chars)",
  "description": "string (required, min 10 chars)",
  "category": "string (required)",
  "condition": "string (optional, enum: ['new', 'used', 'refurbished'], default: 'new')",
  "price": "number (required, > 0)",
  "images": "string[] (optional, array of image URLs)",
  "ownerId": "number (optional, admin only - for assigning product to specific seller)",
  "trialPolicy": {                      // optional trial policy configuration
    "trialDays": "number (> 0)",      // length of trial in days
    "penaltyType": "string",          // e.g. 'flat' or 'percentage'
    "penaltyValue": "number (>= 0)",  // penalty amount
    "returnWindowHours": "number (> 0)" // allowed return window in hours
  }
}</pre>
      </li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>201: <code>{ "success": true, "data": Product }</code></li>
      <li>400: <code>{ "success": false, "message": "Validation error", "errors": [...] }</code></li>
      <li>401: <code>{ "success": false, "message": "Unauthorized" }</code></li>
      <li>403: <code>{ "success": false, "message": "Only sellers and admins can create products" }</code></li>
      <li>500: <code>{ "success": false, "message": "Error creating product", "error": "..." }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">PATCH</span> <code>/api/products/:id</code> <span class="pill protected">JWT (Owner/Admin)</span></div>
    <div>Partially updates an existing product. Only the product owner or admin can update it.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Params: <code>id</code> — Product ID to update (required)</li>
      <li>Body (JSON, all fields optional except for the ones being updated):
<pre>{
  "name": "string (min 3, max 100 chars)",
  "description": "string (min 10 chars)",
  "category": "string",
  "condition": "string (enum: ['new', 'used', 'refurbished'])",
  "price": "number (> 0)",
  "images": "string[] (array of image URLs)",
  "ownerId": "number (admin only - for transferring product ownership)",
  "trialPolicy": {                      // optional create/update of trial policy
    "trialDays": "number (> 0)",
    "penaltyValue": "number (>= 0)",
    "returnWindowHours": "number (> 0)"
  }
}</pre>
      </li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "success": true, "data": { product: UpdatedProduct, trialPolicy: TrialPolicy | null } }</code></li>
      <li>400: <code>{ "success": false, "message": "Validation error", "errors": [...] }</code></li>
      <li>401: <code>{ "success": false, "message": "Unauthorized" }</code></li>
      <li>403: <code>{ "success": false, "message": "Not authorized to update this product" }</code></li>
      <li>404: <code>{ "success": false, "message": "Product not found" }</code></li>
      <li>500: <code>{ "success": false, "message": "Error updating product", "error": "..." }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">DELETE</span> <code>/api/products/:id</code> <span class="pill protected">JWT (Owner/Admin)</span></div>
    <div>Soft deletes a product. Only the product owner or admin can delete it. The product is not actually removed from the database but marked as deleted.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Params: <code>id</code> — Product ID to delete (required)</li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "success": true, "message": "Product deleted successfully" }</code></li>
      <li>401: <code>{ "success": false, "message": "Unauthorized" }</code></li>
      <li>403: <code>{ "success": false, "message": "Not authorized to delete this product" }</code></li>
      <li>404: <code>{ "success": false, "message": "Product not found" }</code></li>
      <li>500: <code>{ "success": false, "message": "Error deleting product", "error": "..." }</code></li>
    </ul>
  </div>

  <h2>Trial Policies</h2>

  <div class="endpoint">
    <div><span class="method">POST</span> <code>/api/products/:id/trial-policy</code> <span class="pill protected">JWT (Seller/Admin)</span></div>
    <div>Creates a trial policy for a product. Only authenticated sellers or admins can create trial policies.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Params: <code>id</code> — Product ID (required)</li>
      <li>Body (JSON):
<pre>{
  "trial_days": "number (required, 1-365)",
  "return_window_hours": "number (required, 1-8760)"
}</pre>
      </li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>201: <code>{ "message": "Trial policy created successfully", "trialPolicy": TrialPolicy }</code></li>
      <li>400: <code>{ "errors": [...] } | { "error": "Product not found" } | { "error": "Trial policy already exists for this product" }</code></li>
      <li>401: <code>{ "message": "Unauthorized" }</code></li>
      <li>500: <code>{ "error": "Internal server error" }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">PATCH</span> <code>/api/products/:id/trial-policy</code> <span class="pill protected">JWT (Seller/Admin)</span></div>
    <div>Updates an existing trial policy. Only the product owner or admin can update it. All fields are optional.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Params: <code>id</code> — Product ID (required)</li>
      <li>Body (JSON, all fields optional):
<pre>{
  "trial_days": "number (1-365)",
  "return_window_hours": "number (1-8760)"
}</pre>
      </li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "message": "Trial policy updated successfully", "trialPolicy": TrialPolicy }</code></li>
      <li>400: <code>{ "errors": [...] }</code></li>
      <li>401: <code>{ "message": "Unauthorized" }</code></li>
      <li>404: <code>{ "error": "Trial policy not found for this product" }</code></li>
      <li>500: <code>{ "error": "Internal server error" }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">DELETE</span> <code>/api/products/:id/trial-policy</code> <span class="pill protected">JWT (Seller/Admin)</span></div>
    <div>Soft deletes/disables a trial policy. Only the product owner or admin can delete it.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Params: <code>id</code> — Product ID (required)</li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "message": "Trial policy disabled successfully" }</code></li>
      <li>401: <code>{ "message": "Unauthorized" }</code></li>
      <li>404: <code>{ "error": "Trial policy not found for this product" }</code></li>
      <li>500: <code>{ "error": "Internal server error" }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">GET</span> <code>/api/products/:id/trial-policy</code> <span class="pill auth">Public</span></div>
    <div>Gets the trial policy for a specific product.</div>
    <h4>Request</h4>
    <ul>
      <li>Params: <code>id</code> — Product ID (required)</li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "trialPolicy": TrialPolicy }</code></li>
      <li>404: <code>{ "error": "Trial policy not found for this product" }</code></li>
      <li>500: <code>{ "error": "Internal server error" }</code></li>
    </ul>
  </div>

  <h2>Buyers</h2>

  <div class="endpoint">
    <div><span class="method">POST</span> <code>/api/buyers/register</code> <span class="pill auth">Public</span></div>
    <div>Registers a buyer with a profile picture and sends OTP.</div>
    <h4>Request</h4>
    <ul>
      <li>Content-Type: <code>multipart/form-data</code></li>
      <li>Form fields:</li>
    </ul>
<pre>firstName: "John"
lastName: "Doe"
username: "johnd"
email: "john@example.com"
phoneNumber: "+1000000000"
password: "secret"
profilePic: &lt;file&gt; // required image file field</pre>
    <h4>Responses</h4>
    <ul>
      <li>201: <code>{ message, buyer: { id, firstName, lastName, username, email, phoneNumber, emailVerified, profilePic } }</code></li>
      <li>400: <code>All fields required | Profile picture required | Username/Email already exists</code></li>
      <li>500: <code>Error registering buyer</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">GET</span> <code>/api/buyers</code> <span class="pill protected">JWT</span></div>
    <div>List buyers.</div>
  </div>
  <div class="endpoint">
    <div><span class="method">GET</span> <code>/api/buyers/:id</code> <span class="pill protected">JWT</span></div>
    <div>Get buyer by id.</div>
  </div>
  <div class="endpoint">
    <div><span class="method">PATCH</span> <code>/api/buyers/:id</code> <span class="pill protected">JWT (self/admin)</span></div>
    <div>Update buyer fields.</div>
  </div>
  <div class="endpoint">
    <div><span class="method">DELETE</span> <code>/api/buyers/:id</code> <span class="pill protected">JWT (self/admin)</span></div>
    <div>Delete buyer.</div>
  </div>

  <h2>Sellers</h2>

  <div class="endpoint">
    <div><span class="method">POST</span> <code>/api/sellers/register</code> <span class="pill auth">Public</span></div>
    <div>Registers a seller with license and profile picture uploads, then sends OTP. Login requires <code>emailVerified=true</code> and <code>approved=true</code>.</div>
    <h4>Request</h4>
    <ul>
      <li>Content-Type: <code>multipart/form-data</code></li>
      <li>Form fields:</li>
    </ul>
<pre>firstName: "Acme"
lastName: "Corp"
username: "acme"
email: "acme@example.com"
password: "secret"
address: "123 Main St"
phoneNumber: "+1000000000"   // optional
storeName: "Acme Store"      // optional
license: &lt;file&gt;             // required image file field
profilePic: &lt;file&gt;          // required image file field</pre>
    <h4>Responses</h4>
    <ul>
      <li>201: <code>{ message, seller: { id, firstName, lastName, phoneNumber, storeName, username, email, address, approved, emailVerified, profilePic, license } }</code></li>
      <li>400: <code>License image required | Profile image required | Username already taken</code></li>
      <li>500: <code>Error registering seller</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">GET</span> <code>/api/sellers</code> <span class="pill protected">JWT (admin)</span></div>
    <div>Get all sellers. Admin only.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "message": "Sellers retrieved successfully", "sellers": [...] }</code></li>
      <li>401: <code>{ "message": "Unauthorized" }</code></li>
      <li>403: <code>{ "message": "Forbidden" }</code></li>
      <li>500: <code>{ "message": "Error retrieving sellers", "error": "..." }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">GET</span> <code>/api/sellers/:id</code> <span class="pill protected">JWT</span></div>
    <div>Get seller by ID. Authenticated users only.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Params: <code>id</code> — Seller ID</li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "message": "Seller retrieved successfully", "seller": { id, firstName, lastName, phoneNumber, storeName, username, email, address, license, approved, emailVerified, profilePic } }</code></li>
      <li>401: <code>{ "message": "Unauthorized" }</code></li>
      <li>404: <code>{ "message": "Seller not found" }</code></li>
      <li>500: <code>{ "message": "Error retrieving seller", "error": "..." }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">PUT</span> <code>/api/sellers/:id</code> <span class="pill protected">JWT</span></div>
    <div>Update seller information. Authenticated users only.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Params: <code>id</code> — Seller ID</li>
    </ul>
    <h4>Request body (all fields optional)</h4>
<pre>{
  "firstName": "Updated Name",
  "lastName": "Updated Last",
  "email": "updated@example.com",
  "address": "Updated Address",
  "license": "NEW-LIC-123",
  "approved": true
}</pre>
    <h4>Responses</h4>
      <li>200: <code>{ "message": "Seller updated successfully", "seller": { id, firstName, lastName, phoneNumber, storeName, username, email, address, license, approved, emailVerified, profilePic } }</code></li>
      <li>401: <code>{ "message": "Unauthorized" }</code></li>
      <li>404: <code>{ "message": "Seller not found" }</code></li>
      <li>500: <code>{ "message": "Error updating seller", "error": "..." }</code></li>
    </ul>
  </div>

  <h2>Orders</h2>

  <div class="endpoint">
    <div><span class="method">POST</span> <code>/api/orders</code> <span class="pill protected">JWT</span></div>
    <div>Creates a new order. Only authenticated buyers can create orders.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Body (JSON):
<pre>{
  "productId": "UUID (required)",
  "trialStartedAt": "ISO date (optional)",
  "trialEndsAt": "ISO date (optional)"
}</pre>
      </li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>201: <code>{ "message": "Order created", "orderId": "UUID", "status": "pending|trial_active" }</code></li>
      <li>400: <code>{ "message": "productId required | Product not available | Buyer not found" }</code></li>
      <li>500: <code>{ "message": "Failed to create order" }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">GET</span> <code>/api/orders</code> <span class="pill auth">Public</span></div>
    <div>Lists all orders with optional filtering and pagination.</div>
    <h4>Request</h4>
    <ul>
      <li>Query Parameters (optional):
        <ul>
          <li><code>status</code> — Filter by order status ("pending", "trial_active", "paid", "returned", "cancelled")</li>
          <li><code>buyerId</code> — Filter by buyer ID</li>
          <li><code>page</code> — Page number (default: 1)</li>
          <li><code>limit</code> — Items per page (default: 20, max: 100)</li>
        </ul>
      </li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "total": number, "page": number, "limit": number, "orders": [...] }</code></li>
      <li>500: <code>{ "message": "Error listing orders", "error": "..." }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">GET</span> <code>/api/orders/:id</code> <span class="pill protected">JWT</span></div>
    <div>Get a specific order by ID with product and buyer details.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Params: <code>id</code> — Order ID (required)</li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "order": {...} }</code></li>
      <li>404: <code>{ "message": "Order not found" }</code></li>
      <li>500: <code>{ "message": "Error fetching order", "error": "..." }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">GET</span> <code>/api/orders/buyer/:buyerId</code> <span class="pill protected">JWT</span></div>
    <div>Get all orders for a specific buyer with pagination. Uses authenticated buyer's username to find correct buyer ID.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Params: <code>buyerId</code> — Buyer ID (required, but function uses authenticated user's username)</li>
      <li>Query Parameters (optional):
        <ul>
          <li><code>page</code> — Page number (default: 1)</li>
          <li><code>limit</code> — Items per page (default: 10, max: 100)</li>
        </ul>
      </li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "total": number, "page": number, "limit": number, "orders": [...] }</code></li>
      <li>400: <code>{ "message": "Buyer not found" }</code></li>
      <li>500: <code>{ "message": "Error fetching orders", "error": "..." }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">GET</span> <code>/api/orders/seller/:sellerId</code> <span class="pill protected">JWT</span></div>
    <div>Get all orders for products belonging to a specific seller. Uses INNER JOIN to filter orders by product ownership.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Params: <code>sellerId</code> — Seller/User ID (required)</li>
      <li>Query Parameters (optional):
        <ul>
          <li><code>status</code> — Filter by order status ("pending", "trial_active", "paid", "returned", "cancelled", "return_requested", "disputed")</li>
          <li><code>page</code> — Page number (default: 1)</li>
          <li><code>limit</code> — Items per page (default: 10, max: 100)</li>
        </ul>
      </li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "total": number, "page": number, "limit": number, "orders": [...] }</code></li>
      <li>500: <code>{ "message": "Error fetching seller orders", "error": "..." }</code></li>
    </ul>
  </div>

  <h2>Returns</h2>

  <div class="endpoint">
    <div><span class="method">POST</span> <code>/api/returns</code> <span class="pill protected">JWT (Buyer)</span></div>
    <div>Initiate a return for an order. Only allowed during active trial period. Creates return record with QR token and updates order status.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Body (JSON):
<pre>{
  "orderId": "UUID (required)",
  "hasDefect": "boolean (optional)",
  "defectDescription": "string (required if hasDefect is true)",
  "defectPhotoUrl": "string (optional, required if hasDefect is true)"
}</pre>
      </li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>201: <code>{ "message": "Return initiated successfully", "return": { id, orderId, returnToken, status, requestedAt, expiresAt, hasDefect } }</code></li>
      <li>400: <code>{ "message": "Order ID is required | Order not found | Not authorized to return this order | Return can only be initiated during trial period | Trial period has expired | Return already initiated for this order" }</code></li>
      <li>403: <code>{ "message": "Not authorized to return this order" }</code></li>
      <li>404: <code>{ "message": "Order not found" }</code></li>
      <li>500: <code>{ "message": "Error initiating return", "error": "..." }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">POST</span> <code>/api/returns/scan</code> <span class="pill protected">JWT (Seller)</span></div>
    <div>Seller scans QR code to accept return or claim defect. Supports file upload for defect photos.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Content-Type: <code>multipart/form-data</code></li>
      <li>Form fields:
<pre>returnToken: "string (required)"
action: "confirm | claim_defect (required)"
defectDescription: "string (required if action=claim_defect)"
defectPhoto: &lt;file&gt; (required if action=claim_defect)</pre>
      </li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "message": "Return confirmed - Money released to buyer" | "Defect claim submitted - Dispute created for admin review" }</code></li>
      <li>400: <code>{ "message": "Return token is required | Action must be 'confirm' or 'claim_defect' | Photo and description required for defect claim | Return request has expired" }</code></li>
      <li>403: <code>{ "message": "Unauthorized: You are not the seller" }</code></li>
      <li>404: <code>{ "message": "Invalid QR Code or Return not found" }</code></li>
      <li>500: <code>{ "message": "Error processing return scan", "error": "..." }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">GET</span> <code>/api/returns/order/:orderId</code> <span class="pill protected">JWT</span></div>
    <div>Get return details for a specific order. Only accessible by the order buyer or admins.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Params: <code>orderId</code> — Order ID (required)</li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "return": { id, orderId, returnToken, status, requestedAt, expiresAt, scannedAt, defectPhotoUrl, defectDescription, createdAt, updatedAt, order } }</code></li>
      <li>400: <code>{ "message": "Order ID is required" }</code></li>
      <li>403: <code>{ "message": "Not authorized to view this return" }</code></li>
      <li>404: <code>{ "message": "Return not found for this order" }</code></li>
      <li>500: <code>{ "message": "Error fetching return", "error": "..." }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">GET</span> <code>/api/returns/seller/:sellerId</code> <span class="pill protected">JWT</span></div>
    <div>Get all returns for products belonging to a specific seller with pagination and filtering.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Params: <code>sellerId</code> — Seller ID (required)</li>
      <li>Query Parameters (optional):
        <ul>
          <li><code>status</code> — Filter by return status ("pending", "confirmed", "defect_claimed", "expired")</li>
          <li><code>page</code> — Page number (default: 1)</li>
          <li><code>limit</code> — Items per page (default: 10, max: 100)</li>
        </ul>
      </li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "total": number, "page": number, "limit": number, "returns": [...] }</code></li>
      <li>400: <code>{ "message": "Seller ID is required" }</code></li>
      <li>500: <code>{ "message": "Error fetching seller returns", "error": "..." }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">GET</span> <code>/api/returns/buyer/:buyerId</code> <span class="pill protected">JWT</span></div>
    <div>Get all returns for a specific buyer with pagination and filtering.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Params: <code>buyerId</code> — Buyer ID (required)</li>
      <li>Query Parameters (optional):
        <ul>
          <li><code>status</code> — Filter by return status ("pending", "confirmed", "defect_claimed", "expired")</li>
          <li><code>page</code> — Page number (default: 1)</li>
          <li><code>limit</code> — Items per page (default: 10, max: 100)</li>
        </ul>
      </li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "total": number, "page": number, "limit": number, "returns": [...] }</code></li>
      <li>400: <code>{ "message": "Buyer ID is required" }</code></li>
      <li>500: <code>{ "message": "Error fetching buyer returns", "error": "..." }</code></li>
    </ul>
  </div>

  <h2>Admin</h2>

  <div class="endpoint">
    <div><span class="method">PATCH</span> <code>/api/admin/sellers/:id/approve</code> <span class="pill protected">JWT (Admin)</span></div>
    <div>Approve a seller account. Only admins can approve sellers.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Params: <code>id</code> — Seller ID</li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "message": "Seller approved successfully" }</code></li>
      <li>401: <code>{ "message": "Unauthorized" }</code></li>
      <li>403: <code>{ "message": "Forbidden" }</code></li>
      <li>404: <code>{ "message": "Seller not found" }</code></li>
      <li>500: <code>{ "message": "Error approving seller", "error": "..." }</code></li>
    </ul>
  </div>

  <h2>Rental Products</h2>

  <div class="endpoint">
    <div><span class="method">GET</span> <code>/api/rentals</code> <span class="pill auth">Public</span></div>
    <div>Lists all available rental products with pagination.</div>
    <h4>Request</h4>
    <ul>
      <li>Query Parameters (optional):
        <ul>
          <li><code>page</code> — Page number (default: 1)</li>
          <li><code>limit</code> — Items per page (default: 10, max: 100)</li>
        </ul>
      </li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "success": true, "data": [...], "pagination": {...} }</code></li>
      <li>500: <code>{ "success": false, "message": "Error retrieving rentables", "error": "..." }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">GET</span> <code>/api/rentals/:id</code> <span class="pill auth">Public</span></div>
    <div>Get a specific rental product by ID.</div>
    <h4>Request</h4>
    <ul>
      <li>Params: <code>id</code> — Product ID (required)</li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "success": true, "data": {...} }</code></li>
      <li>404: <code>{ "success": false, "message": "Rentable not found" }</code></li>
      <li>500: <code>{ "success": false, "message": "Error retrieving rentable", "error": "..." }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">POST</span> <code>/api/rentals</code> <span class="pill protected">JWT (Seller/Admin)</span></div>
    <div>Creates a new product and rental listing in a single transaction. Supports image uploads.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Content-Type: <code>multipart/form-data</code> (for image uploads) or <code>application/json</code></li>
      <li>Body fields:</li>
    </ul>
<pre>name: "string (required)"
description: "string (required)"
category: "string (required)"
condition: "string (optional, enum: ['new', 'used', 'refurbished'], default: 'new')"
price: "number (required, > 0)"
dailyRate: "number (required, > 0)"
penaltyRate: "number (optional, default: 0.00)"
images: "file[] (optional, up to 10 images)"
ownerId: "UUID (optional, admin only - for assigning to specific seller)"</pre>
    <h4>Responses</h4>
    <ul>
      <li>201: <code>{ "success": true, "message": "Product and Rental listing created successfully", "data": { product, rentable } }</code></li>
      <li>400: <code>{ "success": false, "errors": [...] }</code></li>
      <li>401: <code>{ "success": false, "message": "Unauthorized" }</code></li>
      <li>403: <code>{ "success": false, "message": "Only sellers and admins can create products" }</code></li>
      <li>500: <code>{ "success": false, "message": "Error creating rental product", "error": "..." }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">PATCH</span> <code>/api/rentals/:id</code> <span class="pill protected">JWT (Owner/Admin)</span></div>
    <div>Updates both product and rental details. Only the product owner or admin can update.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Params: <code>id</code> — Product ID (required)</li>
      <li>Body (JSON, all fields optional):</li>
    </ul>
<pre>{
  "name": "string",
  "description": "string",
  "category": "string",
  "condition": "string (enum: ['new', 'used', 'refurbished'])",
  "price": "number (> 0)",
  "dailyRate": "number (> 0)",
  "penaltyRate": "number",
  "available": "boolean"
}</pre>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "success": true, "message": "Product and rental updated successfully", "product": {...} }</code></li>
      <li>400: <code>{ "success": false, "errors": [...] }</code></li>
      <li>401: <code>{ "success": false, "message": "Unauthorized" }</code></li>
      <li>403: <code>{ "success": false, "message": "Not authorized to update this rental" }</code></li>
      <li>404: <code>{ "success": false, "message": "Product not found or not rentable" }</code></li>
      <li>500: <code>{ "success": false, "message": "Error updating rental", "error": "..." }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">DELETE</span> <code>/api/rentals/:id</code> <span class="pill protected">JWT (Owner/Admin)</span></div>
    <div>Deletes a rental product. Only the product owner or admin can delete.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Params: <code>id</code> — Product ID (required)</li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "success": true, "message": "Rentable product deleted successfully" }</code></li>
      <li>401: <code>{ "success": false, "message": "Unauthorized" }</code></li>
      <li>403: <code>{ "success": false, "message": "Not authorized to delete this rental" }</code></li>
      <li>404: <code>{ "success": false, "message": "Rentable product not found" }</code></li>
      <li>500: <code>{ "success": false, "message": "Error deleting rental", "error": "..." }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">GET</span> <code>/api/rentals/renter/:renterId</code> <span class="pill protected">JWT</span></div>
    <div>Get all rental products listed by a specific seller (renter). Users can only view their own listings unless admin.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Params: <code>renterId</code> — Seller/User ID</li>
      <li>Query: <code>page</code>, <code>limit</code> (optional)</li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "success": true, "rentables": [...], "pagination": {...} }</code></li>
      <li>401: <code>{ "success": false, "message": "Unauthorized" }</code></li>
      <li>403: <code>{ "success": false, "message": "You can only view your own rentable listings" }</code></li>
      <li>500: <code>{ "success": false, "message": "Error retrieving rentals", "error": "..." }</code></li>
    </ul>
  </div>

  <h2>Rental Orders</h2>

  <div class="endpoint">
    <div><span class="method">POST</span> <code>/api/rental-orders</code> <span class="pill protected">JWT</span></div>
    <div>Creates a new rental order booking. Automatically calculates costs and checks availability.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Body (JSON):
<pre>{
  "rentableId": "UUID (required)",
  "startDate": "ISO date (required, cannot be in past)",
  "endDate": "ISO date (required, must be after start date)",
  "notes": "string (optional, max 1000 chars)"
}</pre>
      </li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>201: <code>{ "success": true, "message": "Rental order created successfully", "data": {...} }</code></li>
      <li>400: <code>{ "success": false, "message": "Rentable product not found or not available | Product is not available for selected dates | You cannot rent your own product" }</code></li>
      <li>401: <code>{ "success": false, "message": "Unauthorized" }</code></li>
      <li>500: <code>{ "success": false, "message": "Error creating rental order", "error": "..." }</code></li>
    </ul>
    <div class="note">Automatically calculates totalCost (dailyRate × rental days) and depositAmount (20% of totalCost).</div>
  </div>

  <div class="endpoint">
    <div><span class="method">GET</span> <code>/api/rental-orders</code> <span class="pill protected">JWT</span></div>
    <div>Lists all rental orders with filtering and pagination. Admins can see all, users see their own.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Query Parameters (optional):
        <ul>
          <li><code>page</code> — Page number (default: 1)</li>
          <li><code>limit</code> — Items per page (default: 10, max: 100)</li>
          <li><code>status</code> — Filter by status ("pending", "active", "completed", "cancelled", "overdue")</li>
          <li><code>renterId</code> — Filter by renter ID (admin only)</li>
          <li><code>startDate</code> & <code>endDate</code> — Filter by date range</li>
        </ul>
      </li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "success": true, "data": [...], "pagination": {...} }</code></li>
      <li>500: <code>{ "success": false, "message": "Error fetching rental orders", "error": "..." }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">GET</span> <code>/api/rental-orders/my-orders</code> <span class="pill protected">JWT</span></div>
    <div>Get current user's rental orders with pagination and filtering.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Query Parameters (optional):
        <ul>
          <li><code>page</code> — Page number (default: 1)</li>
          <li><code>limit</code> — Items per page (default: 10, max: 100)</li>
          <li><code>status</code> — Filter by status</li>
        </ul>
      </li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "success": true, "data": [...], "pagination": {...} }</code></li>
      <li>500: <code>{ "success": false, "message": "Error fetching user rental orders", "error": "..." }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">GET</span> <code>/api/rental-orders/:id</code> <span class="pill protected">JWT</span></div>
    <div>Get a specific rental order by ID with full details.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Params: <code>id</code> — Rental Order ID (required)</li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "success": true, "data": {...} }</code></li>
      <li>403: <code>{ "success": false, "message": "You do not have permission to view this rental order" }</code></li>
      <li>404: <code>{ "success": false, "message": "Rental order not found" }</code></li>
      <li>500: <code>{ "success": false, "message": "Error fetching rental order", "error": "..." }</code></li>
    </ul>
    <div class="note">Users can view their own orders, product owners can view orders for their products, admins can view all.</div>
  </div>

  <div class="endpoint">
    <div><span class="method">PATCH</span> <code>/api/rental-orders/:id</code> <span class="pill protected">JWT</span></div>
    <div>Updates a rental order. Can modify dates, status, or notes. Recalculates costs if dates change.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Params: <code>id</code> — Rental Order ID (required)</li>
      <li>Body (JSON, all fields optional):
<pre>{
  "startDate": "ISO date",
  "endDate": "ISO date",
  "status": "pending|active|completed|cancelled|overdue",
  "notes": "string (max 1000 chars)"
}</pre>
      </li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "success": true, "message": "Rental order updated successfully", "data": {...} }</code></li>
      <li>400: <code>{ "success": false, "message": "Product is not available for the selected dates" }</code></li>
      <li>403: <code>{ "success": false, "message": "You do not have permission to update this rental order" }</code></li>
      <li>404: <code>{ "success": false, "message": "Rental order not found" }</code></li>
      <li>500: <code>{ "success": false, "message": "Error updating rental order", "error": "..." }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">DELETE</span> <code>/api/rental-orders/:id</code> <span class="pill protected">JWT</span></div>
    <div>Deletes a rental order. Only allowed for pending orders.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Params: <code>id</code> — Rental Order ID (required)</li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "success": true, "message": "Rental order deleted successfully" }</code></li>
      <li>400: <code>{ "success": false, "message": "Cannot delete rental order that is not pending" }</code></li>
      <li>403: <code>{ "success": false, "message": "You do not have permission to delete this rental order" }</code></li>
      <li>404: <code>{ "success": false, "message": "Rental order not found" }</code></li>
      <li>500: <code>{ "success": false, "message": "Error deleting rental order", "error": "..." }</code></li>
    </ul>
    <div class="note">Only pending orders can be deleted. Active or completed orders cannot be deleted.</div>
  </div>

  <h2>Payments</h2>

  <div class="endpoint">
    <div><span class="method">POST</span> <code>/api/payments/initiate</code> <span class="pill protected">JWT</span></div>
    <div>Initiates payment with Chapa for a specific order. Creates payment record and returns checkout URL.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Authorization: Bearer &lt;token&gt;</code></li>
      <li>Body (JSON):
<pre>{
  "orderId": "UUID (required)"
}</pre>
      </li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ "checkoutUrl": "https://checkout.chapa.co/...", "hasTrial": boolean }</code></li>
      <li>400: <code>{ "message": "orderId required | Order not payable" }</code></li>
      <li>404: <code>{ "message": "Order not found" }</code></li>
      <li>500: <code>{ "message": "Payment initiation failed | Failed to get checkout URL from Chapa" }</code></li>
    </ul>
  </div>

  <div class="endpoint">
    <div><span class="method">POST</span> <code>/api/payments/verify</code> <span class="pill auth">Public</span></div>
    <div>Chapa webhook endpoint for payment verification. Processes payment callbacks and updates payment/order status. Redirects to success/failure pages.</div>
    <h4>Request</h4>
    <ul>
      <li>Headers: <code>Content-Type: application/json</code></li>
      <li>Body (JSON) - Sent by Chapa:
<pre>{
  "trx_ref": "string (required) - Chapa transaction reference",
  "ref_id": "string - Chapa reference ID",
  "status": "string - Payment status from Chapa"
}</pre>
      </li>
      <li>Query Parameters (alternative):
        <ul>
          <li><code>trx_ref</code> - Transaction reference (when sent as query params)</li>
          <li><code>tx_ref</code> - Alternative transaction reference field</li>
        </ul>
      </li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>302: Redirect to <code>http://localhost:3000/payment-success or what ever the frontend is configured to redirect to</code> (successful payment)</li>
      <li>302: Redirect to <code>http://localhost:3000/payment-failed or what ever the frontend is configured to redirect to</code> (failed payment)</li>
      <li>400: <code>{ "message": "Transaction reference required" }</code></li>
      <li>404: <code>{ "message": "Payment not found" }</code></li>
      <li>500: <code>{ "message": "Payment verification failed" }</code></li>
    </ul>
    <div class="note">This is a webhook endpoint called by Chapa. Also handles browser redirects from payment completion.</div>
  </div>

  <div class="endpoint">
    <div><span class="method">GET</span> <code>/api/payments/verifyy</code> <span class="pill auth">Public</span></div>
    <div>Browser redirect endpoint after payment completion. Simply redirects to success page.</div>
    <h4>Request</h4>
    <ul>
      <li>No parameters required</li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>302: Redirect to <code>http://localhost:3000/payment-success</code></li>
    </ul>
    <div class="note">This endpoint handles the browser redirect from Chapa checkout. The 'y' in 'verifyy' distinguishes it from the webhook endpoint.</div>
  </div>

  <div class="endpoint">
    <div><span class="method">GET</span> <code>/api/payments/status</code> <span class="pill auth">Public</span></div>
    <div>Checks the current status of a payment using transaction reference.</div>
    <h4>Request</h4>
    <ul>
      <li>Query Parameters (required):
        <ul>
          <li><code>txRef</code> - Chapa transaction reference</li>
        </ul>
      </li>
    </ul>
    <h4>Responses</h4>
    <ul>
      <li>200: <code>{ 
  "payment": {
    "status": "pending|released_to_seller|held_in_escrow|failed",
    "amount": "number",
    "currency": "string",
    "paidAt": "ISO date | null",
    "chapaTxRef": "string"
  },
  "order": {
    "id": "UUID",
    "status": "pending|trial_active|paid|returned|cancelled",
    "trialEndsAt": "ISO date | null",
    "hasTrial": "boolean"
  }
}</code></li>
      <li>400: <code>{ "message": "Transaction reference (txRef) is required" }</code></li>
      <li>404: <code>{ "message": "Payment not found" | "Order not found for this payment" }</code></li>
      <li>500: <code>{ "message": "Failed to check payment status", "error": "..." }</code></li>
    </ul>
  </div>

  <h2>Security</h2>
  <ul>
    <li><strong>JWT Secret</strong>: <code>JWT_SECRET</code> env must be configured.</li>
    <li><strong>Auth header</strong>: <code>Authorization: Bearer &lt;token&gt;</code> for protected endpoints.</li>
  </ul>
</body>
</html>
